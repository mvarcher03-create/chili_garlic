{% extends 'admin_base.html' %}

{% block title %}Products · Chili Garlic House{% endblock %}

{% block header_title %}Products{% endblock %}

{% block content %}
	<section style="display:flex; flex-direction:column; gap:1rem;">
		<div class="card-surface" style="padding:0.9rem 1rem; overflow-x:auto;">
			<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.4rem; gap:0.75rem; flex-wrap:wrap;">
				<div>
					<h2 style="font-size:0.95rem; margin-bottom:0.15rem;">All products</h2>
					<p style="font-size:0.8rem; color:#6b7280; margin:0;">Review and manage all chili garlic products in your catalog.</p>
				</div>
				<div style="display:flex; align-items:center; gap:0.5rem;">
					<form method="get" style="display:flex; align-items:center; gap:0.25rem;">
						<input type="text" name="q" placeholder="Search product..." value="{{ query }}" style="padding:0.35rem 0.6rem; border-radius:999px; border:1px solid #d1d5db; font-size:0.8rem;" />
						<button type="submit" class="btn btn-outline" style="padding:0.3rem 0.7rem; font-size:0.8rem;">Search</button>
					</form>
					<button type="button" class="btn btn-primary" id="add-product-toggle">
						{% if editing %}Close{% else %}Add product{% endif %}
					</button>
				</div>
			</div>
			<div style="display:flex; flex-wrap:wrap; gap:0.4rem; margin-bottom:0.4rem; font-size:0.78rem;">
				{% with current=active_category %}
					<a href="?{% if query %}q={{ query }}{% endif %}" style="padding:0.25rem 0.7rem; border-radius:999px; border:1px solid {% if not current %}#b91c1c{% else %}#e5e7eb{% endif %}; background:{% if not current %}#fee2e2{% else %}#ffffff{% endif %}; color:{% if not current %}#b91c1c{% else %}#6b7280{% endif %}; text-decoration:none;">All</a>
					<a href="?{% if query %}q={{ query }}&amp;{% endif %}category=bottled" style="padding:0.25rem 0.7rem; border-radius:999px; border:1px solid {% if current == 'bottled' %}#b91c1c{% else %}#e5e7eb{% endif %}; background:{% if current == 'bottled' %}#fee2e2{% else %}#ffffff{% endif %}; color:{% if current == 'bottled' %}#b91c1c{% else %}#6b7280{% endif %}; text-decoration:none;">Bottled</a>
					<a href="?{% if query %}q={{ query }}&amp;{% endif %}category=meal" style="padding:0.25rem 0.7rem; border-radius:999px; border:1px solid {% if current == 'meal' %}#b91c1c{% else %}#e5e7eb{% endif %}; background:{% if current == 'meal' %}#fee2e2{% else %}#ffffff{% endif %}; color:{% if current == 'meal' %}#b91c1c{% else %}#6b7280{% endif %}; text-decoration:none;">Meals</a>
					<a href="?{% if query %}q={{ query }}&amp;{% endif %}category=snack" style="padding:0.25rem 0.7rem; border-radius:999px; border:1px solid {% if current == 'snack' %}#b91c1c{% else %}#e5e7eb{% endif %}; background:{% if current == 'snack' %}#fee2e2{% else %}#ffffff{% endif %}; color:{% if current == 'snack' %}#b91c1c{% else %}#6b7280{% endif %}; text-decoration:none;">Snack</a>
					<a href="?{% if query %}q={{ query }}&amp;{% endif %}category=drink" style="padding:0.25rem 0.7rem; border-radius:999px; border:1px solid {% if current == 'drink' %}#b91c1c{% else %}#e5e7eb{% endif %}; background:{% if current == 'drink' %}#fee2e2{% else %}#ffffff{% endif %}; color:{% if current == 'drink' %}#b91c1c{% else %}#6b7280{% endif %}; text-decoration:none;">Drinks</a>
				{% endwith %}
			</div>
			<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(260px, 320px)); justify-content:flex-start; gap:0.9rem; margin-top:0.1rem;">
				{% for product in products %}
					<article style="border-radius:0.9rem; border:1px solid #e5e7eb; background:#ffffff; padding:0.6rem 0.7rem; display:flex; flex-direction:column; gap:0.5rem; align-items:stretch;">
						<div style="width:100%;">
							{% if product.image %}
								<img src="{{ product.image.url }}" alt="{{ product.name }}" style="width:100%; height:140px; border-radius:0.8rem; object-fit:contain; border:1px solid #e5e7eb; background:#ffffff;" />
							{% else %}
								<div style="width:100%; height:140px; border-radius:0.8rem; border:1px dashed #e5e7eb; display:flex; align-items:center; justify-content:center; font-size:0.7rem; color:#9ca3af;">No image</div>
							{% endif %}
						</div>
						<div style="flex:1; min-width:0;">
							<div style="display:flex; justify-content:space-between; align-items:flex-start; gap:0.4rem; margin-bottom:0.2rem;">
								<div>
									<div style="font-size:0.95rem; font-weight:600;">{{ product.name }}</div>
									<div style="font-size:0.75rem; color:#6b7280;">{{ product.get_category_display }}</div>
								</div>
								<div style="font-size:0.9rem; font-weight:600; color:#b91c1c;">₱{{ product.price }}</div>
							</div>
							<div style="display:flex; justify-content:space-between; align-items:center; gap:0.4rem; margin-bottom:0.25rem;">
								<div style="display:flex; flex-direction:column; gap:0.15rem;">
									<div>
										{% if product.is_active %}
											<span class="badge-pill-yellow">Active</span>
										{% else %}
											<span style="font-size:0.75rem; padding:0.15rem 0.55rem; border-radius:999px; background:#f3f4f6; border:1px solid #e5e7eb;">Inactive</span>
										{% endif %}
									</div>
									<div style="font-size:0.75rem;">
										{% if product.is_active and product.stock > 0 %}
											<span class="badge-pill-yellow">In stock: {{ product.stock }}</span>
										{% elif product.is_active and product.stock <= 0 %}
											<span class="badge-pill-red">Out of stock</span>
										{% else %}
											<span style="color:#6b7280;">Hidden from customers</span>
										{% endif %}
									</div>
								</div>
								<div style="font-size:0.7rem; color:#9ca3af;">{{ product.created_at|date:'Y-m-d H:i' }}</div>
							</div>
							<div style="font-size:0.8rem;">
								<a href="{% url 'admin_product_edit' product.pk %}" style="margin-right:0.4rem; color:#b91c1c; text-decoration:none; border-bottom:1px dashed rgba(248,113,113,0.7);">Edit</a>
								<a href="{% url 'admin_product_delete' product.pk %}" style="font-size:0.8rem; color:#ef4444; text-decoration:none; border-bottom:1px dashed rgba(248,113,113,0.7);">Delete</a>
							</div>
						</div>
					</article>
				{% empty %}
					<div style="font-size:0.8rem; color:#6b7280; padding-top:0.4rem;">No products yet.</div>
				{% endfor %}
			</div>
		</div>

		<div id="product-modal-backdrop" style="position:fixed; inset:0; background:rgba(15,23,42,0.35); {% if editing %}display:flex;{% else %}display:none;{% endif %} align-items:center; justify-content:center; padding:1rem; z-index:40;">
			<div style="max-width:480px; width:100%;">
				<div class="card-surface" style="padding:0.9rem 1rem; position:relative;">
					<button type="button" id="product-modal-close" style="position:absolute; top:0.6rem; right:0.7rem; border:none; background:transparent; font-size:1rem; cursor:pointer; color:#6b7280;">×</button>
					<h2 style="font-size:0.95rem; margin-bottom:0.35rem;">
						{% if editing %}Edit product{% else %}Add new product{% endif %}
					</h2>
					{% if editing %}
						<p style="font-size:0.8rem; color:#6b7280; margin-bottom:0.6rem;">Editing: {{ editing_product.name }}</p>
					{% else %}
						<p style="font-size:0.8rem; color:#6b7280; margin-bottom:0.6rem;">Fill in details to add a new chili garlic product.</p>
					{% endif %}

					<form method="post" enctype="multipart/form-data" style="font-size:0.85rem;">
						{% csrf_token %}
						{{ form.non_field_errors }}

						{% for field in form %}
							<div style="margin-bottom:0.6rem;">
								<label for="id_{{ field.name }}" style="display:block; margin-bottom:0.15rem; color:#374151;">{{ field.label }}</label>
								{{ field }}
								{% if field.help_text %}
									<p style="font-size:0.75rem; color:#6b7280; margin-top:0.15rem;">{{ field.help_text }}</p>
								{% endif %}
								{{ field.errors }}
							</div>
						{% endfor %}

						<button type="submit" class="btn btn-primary" style="width:100%; margin-top:0.4rem;">
							{% if editing %}Update product{% else %}Add product{% endif %}
						</button>
					</form>
				</div>
			</div>
		</div>
	</section>
	<script>
		(function () {
			var backdrop = document.getElementById('product-modal-backdrop');
			var toggle = document.getElementById('add-product-toggle');
			var closeBtn = document.getElementById('product-modal-close');
			if (!backdrop) return;

			function openModal() {
				backdrop.style.display = 'flex';
				if (toggle) toggle.textContent = 'Close';
			}

			function closeModal() {
				backdrop.style.display = 'none';
				if (toggle) toggle.textContent = 'Add product';
			}

			if (toggle) {
				toggle.addEventListener('click', function () {
					var isHidden = backdrop.style.display === 'none' || backdrop.style.display === '';
					if (isHidden) {
						openModal();
					} else {
						closeModal();
					}
				});
			}

			if (closeBtn) {
				closeBtn.addEventListener('click', function () {
					closeModal();
				});
			}
		})();
	</script>
{% endblock %}
